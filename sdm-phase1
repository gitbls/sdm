#!/bin/bash
# This script runs in the nspawn image
#

function p1exit() {
    #
    # Clean up when Phase 1 (or any of the container commands) exits
    #
    unadjust_initramfs_all
    exit
}

function doctrlcp1() {
    echo "% Caught CTRL/C. Exiting Phase 1..."
    unadjust_initramfs_all  #Be clean
    exit 1     #Can't use poweroff since no job control in either nspawn or chroot
}

function logfreeandexit() {
    local sts=$?
    logfreespace "at end of 'apt $cmdoptions'"
    exit $sts
}

#
# Read configuration information from sdm
#
source /etc/sdm/sdm-readparams

trap "doctrlcp1" SIGINT
trap p1exit EXIT
logtoboth "* Start Phase 1 image customization"
logfreespace "at start of Phase 1 image customization"
runoneplugin sdm.phaseops 1 "ops=apt-cacher,apt-conf,apt-update" || exit

if [ "$cscript" != "" ]
then
    csfn="$sdmdir/$(basename $cscript)"
    logtoboth "> Run Custom Phase Script '$csfn' Phase 1" 
    $csfn 1 || exit
else
    csfn=""
fi
#
# Run requested plugins Phase 1
#
runplugins "$plugins" 1 || exit
#
# Post-install Configuration
#
logtoboth "* Phase 1 post-app installation/configuration"

runoneplugin sdm.phaseops 1 "ops=apt-upgrade" || exit

logfreespace "at end of Phase 1 image customization"
logtoboth "* Phase 1 Completed"

if [ "$csfn" != "" ]
then
    logtoboth "> Run Custom Phase Script '$csfn' post-install"
    $csfn post-install || exit
fi
#
# Run requested plugins post-install phase
#
runplugins "$plugins" post-install || exit
#
# Run final post-customization stuff
#
runoneplugin sdm.phaseops 1 "ops=apt-autoremove,config-firstboot,graphics,ssh,writeL10n,finish-customization" || exit
#
# Report run time
#
customizeend="$(getcdate)"
logtoboth "> Customize elapsed time: $(datediff $customizestart $customizeend)"
if grep -q ' % ' /etc/sdm/history
then
    logtoboth ""
    logtoboth "% Customization warning messages:"
    logtoboth "  $(grep ' % ' /etc/sdm/history | grep -v 'Customization warning messages:')"
    logtoboth ""
fi
if [ $fbatch -eq 0 ]
then
    runoneplugin sdm.phaseops 1 "op=shell"
else
    logtoboth "* Customization complete"
    logtoboth "* Batch Mode exit"
fi
exit 0
